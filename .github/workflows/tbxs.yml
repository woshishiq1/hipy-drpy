name: Sync Gitee to subfolder and unzip to main

on:
  schedule:
    - cron: '0 16 */2 * *'  # æ¯ä¸¤å¤©åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œ
  workflow_dispatch:

jobs:
  sync_and_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Set up Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create gitee-source folder and clean it
        run: |
          mkdir -p gitee-source
          rm -rf gitee-source/*

      - name: Download Gitee repo ZIP and extract to gitee-source/
        run: |
          wget -O gitee.zip https://gitee.com/PizazzXS/another-d/repository/archive/master.zip
          unzip gitee.zip
          cp -r another-d-master/* gitee-source/
          rm -rf another-d-master gitee.zip

      - name: Commit synced content to sync-from-gitee branch
        run: |
          git checkout -B sync-from-gitee
          git add gitee-source/
          git commit -m "Sync Gitee project to gitee-source/" || echo "No changes"
          git push origin sync-from-gitee --force

      - name: è§£å‹ ZIP æ–‡ä»¶åˆ°å­æ–‡ä»¶å¤¹å¹¶æäº¤
        run: |
          cd gitee-source

          unzip_and_track() {
            zip_name="$1"
            dir_name="$2"

            if [ -f "$zip_name" ]; then
              echo "âœ… è§£å‹ $zip_name åˆ° $dir_name/"
              mkdir -p "$dir_name"
              unzip -o "$zip_name" -d "$dir_name/"
              touch "$dir_name/.gitkeep"  # ç¡®ä¿ Git è·Ÿè¸ªç›®å½•
            else
              echo "âš ï¸ $zip_name ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          }

          unzip_and_track "å•çº¿è·¯.zip" "å•çº¿è·¯"
          unzip_and_track "å¤šçº¿è·¯.zip" "å¤šçº¿è·¯"

          cd ..

          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹ï¼š"
          ls -R gitee-source/

          git add gitee-source/
          git status

          git commit -m "å°† ZIP æ–‡ä»¶è§£å‹åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ï¼ˆä¿ç•™ ZIP æ–‡ä»¶ï¼‰" || echo "No changes"
          git push origin sync-from-gitee --force

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync-from-gitee
          title: "ğŸ”„ åŒæ­¥ Gitee æ›´æ–°å¹¶è§£å‹ ZIP åˆ°æŒ‡å®šç›®å½•"
          body: |
            æ­¤ PR è‡ªåŠ¨ä» Gitee é¡¹ç›®åŒæ­¥å†…å®¹ï¼Œå¹¶å°† ZIP æ–‡ä»¶è§£å‹åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ï¼š
            - `gitee-source/å•çº¿è·¯/`
            - `gitee-source/å¤šçº¿è·¯/`
          commit-message: "åŒæ­¥å¹¶è§£å‹ ZIP æ–‡ä»¶"
          base: main
          delete-branch: true

      - name: Enable auto-merge for PR
        if: steps.cpr.outputs.pull-request-url != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

  cleanup_runs:
    runs-on: ubuntu-latest
    needs: sync_and_pr
    steps:
      - name: Delete old workflow runs, keep last 10
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 10
