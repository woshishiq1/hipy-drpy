name: Sync Gitee to subfolder and unzip to master

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: sync_job_lock
  cancel-in-progress: true

jobs:
  sync_and_unzip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout default branch
        uses: actions/checkout@v3

      - name: Set up Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Reset local repo to remote default branch
        run: |
          set -e
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          git fetch origin $DEFAULT_BRANCH
          git checkout $DEFAULT_BRANCH || git checkout -b $DEFAULT_BRANCH
          git reset --hard origin/$DEFAULT_BRANCH
          git clean -fdx

      - name: Fetch subprojects
        run: |
          echo "==== 同步仓库 ===="

          declare -A repos=(
            [AA999OK]="https://github.com/AA999OK/TVBOX"
            [sky4726]="https://github.com/sky4726/sk.git"
            [ediart]="https://github.com/ediart/tvbox.git"
            [lemonguo121]="https://github.com/lemonguo121/BoxRes.git"
            [leexuben]="https://github.com/leexuben/TVBOX-merge.git"
            [YJL]="https://github.com/YJL20190405/TVBOX.git"
            [zheng1976]="https://github.com/zheng197600/tvbox.git"
          )

          for name in "${!repos[@]}"; do
            echo "→ 同步 $name"
            rm -rf "$name" temp-$name
            git clone --depth 1 "${repos[$name]}" "temp-$name"
            mkdir -p "$name"
            cp -r "temp-$name"/* "$name"/
            rm -rf "temp-$name"
          done

      - name: Download and extract Gitee ZIP
        run: |
          mkdir -p gitee-source && rm -rf gitee-source/*
          curl -L -o gitee.zip "https://gitee.com/PizazzXS/another-d/repository/archive/master.zip"
          if unzip -t gitee.zip >/dev/null 2>&1; then
            unzip -q gitee.zip
            cp -r another-d-master/* gitee-source/
            rm -rf another-d-master gitee.zip
          else
            rm -f gitee.zip
          fi

      - name: Commit and push to default branch
        run: |
          git add AA999OK sky4726 ediart lemonguo121 leexuben YJL zheng1976 gitee-source/
          git commit -m "Sync multiple TVBox sources + Gitee another-d" || echo "No changes"
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          git push origin $DEFAULT_BRANCH

      - name: Sync to master branch
        run: |
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          git fetch origin
          git checkout master || git checkout -b master
          git reset --hard origin/$DEFAULT_BRANCH
          git push origin master || true

      - name: Unzip all ZIP files in gitee-source (keep ZIP)
        run: |
          cd gitee-source
          for file in *.zip; do
            [ -e "$file" ] || continue
            unzip -o "$file"
          done
          cd ..

      - name: Commit and force push 解压内容到 master（保留 zip）
        run: |
          git add .
          git commit -m "Reset master and unzip ZIPs" || echo "No changes"
          git push origin master --force

  cleanup_runs:
    runs-on: ubuntu-latest
    needs: sync_and_unzip
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 3
          keep_minimum_runs: 10
